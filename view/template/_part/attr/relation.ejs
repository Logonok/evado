<!-- _part/attr/relation -->

<% const p = {}; %>
<%- include('_params', {p}) %>
<%
const d = {
    showTop: false,
    key: model.PK,
    relName: attr,
    order: {[model.PK]: -1},
    pageSize: 10,
    remove: true,
    unlink: true,
    ...data
};
d.attr = attr;
d.relName = d.relName || attr;

const rel = model.getRelation(d.relName);
const urlParams = {
    rel: d.relName,
    pid: model.getId()
};
d.multiple = rel.isMultiple();

if (d.showBottom === undefined) {
    d.showBottom = d.multiple && d.pageSize > 0;
}
if (d.list !== null) {
    if (d.list === undefined) {
        d.list = ['list-rel', urlParams];
    } else if (typeof d.list === 'string') {
        d.list = [d.list, urlParams];
    }
    d.list = _url(d.list);
}
const relUrl = typeof relRoute === 'undefined' ? rel.model.getControllerClass().NAME : relRoute;
/*
if (d.view !== null) {
    d.view = _url(d.view === undefined ? `${relUrl}/view` : d.view);
} //*/
if (d.create !== null) {
    if (d.create === undefined) {
        d.create = [`${relUrl}/create`, urlParams];
    } else if (typeof d.create === 'string') {
        d.create = [d.create, urlParams];
    } else if (!Array.isArray(d.create)) {
        d.create = [`${relUrl}/create`, Object.assign(urlParams, d.create)];
    }
    d.create = _url(d.create);
}
if (d.clone === true) {
    d.clone = _url(`${relUrl}/clone`);
} else if (Array.isArray(d.clone)) {
    d.clone = _url(d.clone);
}
if (d.update !== null) {
    if (d.update === undefined) {
        d.update = [`${relUrl}/update`, urlParams];
    } else if (typeof d.update === 'string') {
        d.create = [d.update, urlParams];
    } else if (!Array.isArray(d.update)) {
        d.update = [`${relUrl}/update`, Object.assign(urlParams, d.update)];
    }
    d.update = _url(d.update);
}
if (d.link !== null) {
    if (d.link === undefined) {
        d.link = [`${relUrl}/select`, urlParams];
    } else if (typeof d.link === 'string') {
        d.link = [d.link, urlParams];
    }
    d.link = _url(d.link);
}
if (d.modalSort) {
    if (d.modalSort === true) {
        d.modalSort = _url(['sort-rel', urlParams]);
    } else if (Array.isArray(d.modalSort)) {
        d.modalSort = _url(d.modalSort);
    }
}
let hasKeyColumn = false;
for (const column of d.columns) {
    if (column.label === undefined) {
        column.label = rel.model.getAttrLabel(column.name);
    }
    if (column.name === d.key) {
        hasKeyColumn = true;
    }
}
if (!hasKeyColumn) {
    d.columns.unshift({
        name: model.PK,
        hidden: true,
        searchable: true,
        sortable: true
    });
}
if (d.filter && !d.filter.url) {
    d.filter.url = _url(`${relUrl}/filter`);
}
%>
<div class="form-attr form-group<%- p.required %> <%- p.css %>" data-type="relation">
    <label class="control-label <%- p.labelCss %>" title="<%= p.extHint%>"
           data-t="<%- p.translate %>"><%- p.label %></label>
    <div class="<%- p.valueCss %>">
        <div class="box box-grid box-grid-field">
            <input name="<%- p.name %>" type="hidden">
            <div class="box-header">
                <div class="list-controls" data-jam="IndexSorting">
                    <% if (d.link) { %>
                    <button data-id="link" data-index="10" title="Link" class="btn btn-default" type="button">
                        <span class="fa fa-link"></span>
                    </button>
                    <% } if (d.unlink) { %>
                    <button data-id="unlink" data-index="20" title="Unlink" class="btn btn-default mr10" type="button">
                        <span class="fa fa-unlink text-danger"></span>
                    </button>
                    <% } if (d.create) { %>
                    <button data-id="create" data-index="30" title="Create" class="btn btn-success btn-light" type="button">
                        <span class="glyphicon glyphicon-plus"></span>
                    </button>
                    <% } if (d.update) { %>
                    <button data-id="update" data-index="40" title="Update" class="btn btn-warning btn-light" type="button">
                        <span class="glyphicon glyphicon-pencil"></span>
                    </button>
                    <% } if (d.remove) { %>
                    <button data-id="remove" data-index="50" title="Remove" class="btn btn-white" type="button">
                        <span class="glyphicon glyphicon-trash text-danger"></span>
                    </button>
                    <% } %>

                    <button data-id="reload" data-index="60" title="Reload" class="btn btn-default ml10" type="button">
                        <span class="fa fa-sync-alt"></span>
                    </button>

                    <% if (d.modalSort) { %>
                    <button data-id="sort" data-index="70" title="Sort" class="btn btn-white" type="button">
                        <span class="glyphicon glyphicon-sort"></span>
                    </button>
                    <% } if (d.clone) { %>
                    <button data-id="clone" data-index="80" title="Clone" class="btn btn-success btn-light" type="button">
                        <span class="fa fa-copy"></span>
                    </button>
                    <% } if (d.createMultiple) { %>
                    <button data-id="createMultiple" data-index="90" title="Create multiple" class="btn btn-success btn-light" type="button">
                        <span class="glyphicon glyphicon-th"></span>
                    </button>
                    <% } if (typeof tools !== 'undefined') { %>
                    <%- include(_view.get('_part/misc/render'), {data: tools}) %>
                    <% } %>
                </div>
            </div>
            <div class="box-body">
                <div class="data-grid" data-params="<%= JSON.stringify(d) %>">
                    <% if (d.filter) { %>
                    <div class="list-filter">
                        <div class="text-center"><i class="fa fa-spinner fa-spin"></i></div>
                    </div>
                    <% } if (d.showTop) { %>
                    <div class="row">
                        <div class="col-sm-6 col-md-4 col-lg-3">
                            <div class="data-grid-common-search">
                                <input type="text" class="form-control" placeholder="Search...">
                                <span class="advanced-toggle glyphicon glyphicon-cog"
                                      title="Advanced search"></span>
                            </div>
                        </div>
                        <div class="col-sm-6 col-md-8 col-lg-9">
                            <div class="data-grid-column-manager">
                                <button type="button" class="toggle btn btn-default">
                                    <span class="glyphicon glyphicon-cog"></span>
                                </button>
                            </div>
                            <div class="data-grid-page-size hidden">
                                <select class="form-control" title="Page size"></select>
                            </div>
                        </div>
                    </div>
                    <% } %>
                    <div class="table-responsive">
                        <table class="data-grid-table table table-bordered table-striped table-condensed">
                            <thead></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <% if (d.showBottom) { %>
                    <div class="row">
                        <div class="col-md-5">
                            <div class="data-grid-info"></div>
                        </div>
                        <div class="col-md-7">
                            <div class="data-grid-pages">
                                <div class="data-grid-pagination"></div>
                                <select class="data-grid-page-jumper form-control hidden"></select>
                            </div>
                        </div>
                    </div>
                    <% } %>
                </div>
            </div>
            <div class="list-loader overlay"><i class="fa fa-spinner fa-spin"></i></div>
        </div>
        <div class="hint-block" data-t="<%- p.translate %>"><%- p.hint %></div>
        <div class="error-block"></div>
    </div>
</div>